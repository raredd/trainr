---
output:
  html_document:
    css: ~/knitr.css
    fig_caption: yes
    highlight: default
    keep_md: no
    number_sections: no
    theme: journal
    toc: no
---

documentr

```{r, echo = TRUE}
## project directory
projdir <- '~/Documents/documentr/'
```

```{r, eval=FALSE}
## knit in console:
knitr::knit(paste0(projdir, 'documentr.Rmd'), encoding = 'UTF-8')
## convert to html
knitr::knit2html(paste0(projdir, 'documentr.Rmd'), stylesheet = '~/knitr.css')
## open in default browser
browseURL(paste0(projdir, 'documentr.html'))
```

```{r setup, include=FALSE}
library(knitr)
## package options
opts_knit$set(eval.after = 'fig.cap', ## to use chunk calculations in the fig.cap,
                                      ## evaluate captions after chunk
              progress = TRUE, 
              width = 80, 
              verbose = TRUE, 
              par = TRUE)
              
## global chunk options:
opts_chunk$set(cache = FALSE, # cache chunks for faster compiles
               tidy = FALSE, # respect code formatting
               echo = TRUE,  # show/hide code
               dev = 'CairoPNG',  # device options (install.packages('Cairo'))
               dev.args = list(antialias = 'none',
                               bg = 'transparent'), 
               dpi = 150,
               fig.path = 'figure/',   # default
               cache.path = 'cache/',  # default
               fig.align = 'center')
## more http://yihui.name/knitr/options

## customizable functions to run before/after a code chunk 
## and tweak the output of knitr 
## more info: http://yihui.name/knitr/hooks
knit_hooks$set(par = function(before, options, envir) {
                 ## par settings
                 # tune details of base graphics (http://yihui.name/knitr/hooks)
                 if (before && options$fig.show != 'none') 
                   par(mar = c(4,4,.1,.1), 
                       cex.lab = .95,
                       cex.axis = .9, 
                       mgp = c(2,.7,0),
                       tcl=-.3)
                 },
               plot = function(x, options) {
                 ## plot settings
                 fig_fn = paste0(opts_knit$get('base.url'),
                                 paste(x, collapse = '.'))
                 fig.cap <- knitr:::.img.cap(options)
                 style = c('display:block',
                           sprintf('margin: %s;',
                                   switch(options$fig.align,
                                          left = 'auto auto auto 0',
                                          center = 'auto',
                                          right = 'auto 0 auto auto')))
                 addon_args <- ''
                 fig_number_txt <- ''
                 cntr <- getOption('figure_counter', FALSE)
                 if (cntr != FALSE) {
                   if (is.logical(cntr))
                     cntr <- 1
                   ## figure_counter_str allows for custom figure text, 
                   ## eg, <b> Figure %s:</b>
                   ## the %s allows for setting the counter manually to 1a, 1b, 
                   ## etc if needed
                   fig_number_txt <- 
                     sprintf(getOption('figure_counter_str', 'Figure %s: '),
                             ifelse(getOption('figure_counter_roman', FALSE),
                                    as.character(as.roman(cntr)), 
                                    as.character(cntr)))
                   if (is.numeric(cntr))
                     options(figure_counter = cntr + 1)
                   }
                 paste0("<figure><img src='", fig_fn, "'"," ", addon_args,
                        paste0(" style='", paste(style, collapse = '; '), 
                               "'"),'>',
                        '<figcaption>', fig_number_txt, fig.cap, 
                        '</figcaption></figure>')
                 })
options(rstudio.markdownToHTML = 
          function(inputFile, outputFile) {
            require(markdown)
            htmlOptions <- markdownHTMLOptions(defaults = TRUE)
            
            # Now in this section we skip writing to the outputfile
            # and keep the markdown text in the md_txt variable
            md_txt <- markdownToHTML(inputFile, options = htmlOptions,
                                     stylesheet = ifelse(file.exists('~/knitr.css'),
                                                         '~/knitr.css',
                                                         getOption('markdown.HTML.stylesheet')))
          })
 
# Adding the figure number is a little tricky when the format is roman
options(figure_counter = TRUE,
        figure_counter_roman = TRUE,
        LibreOffice_adapt = 'skip')

## all packages to load:
library(rawr)
library(Gmisc)

## fonts for images
library(Cairo)
CairoFonts(regular = 'Calirbi:style=Regular',
           bold = 'Calirbi:style=Bold',
           italic = 'Calibri:style=Italic',
           bolditalic = 'Calibri:style=Bold Italic,BoldItalic',
           symbol = 'Symbol')

info <- sessionInfo()
r_ver <- paste(info$R.version$major, info$R.version$minor, sep = '.')
```

<font align = center>

#### Transparent and reproducible research

Documenting data analysis and creating reports with R projects and [knitr](http://yihui.name/knitr/)

Robert Redd, <a href="mailto:rredd@jimmy.harvard.edu?subject=documentr">email</a>   
Department of Biostatistics and Computational Biology   
Dana Farber Cancer Institute

Most recent compile: `r as.character(format(Sys.Date(), format = '%d %B %Y'))` (`r as.character(R.Version()$version.string)`)

</font>

<font size = 1>
All analyses were performed using `r R.Version()$version.string` and packages `Gmisc` v`r info$otherPkgs$Gmisc$Version` for table output ; `rawr` v`r info$otherPkgs$rawr$Version` ([source](https://github.com/raredd/rawr)), a personal package with helper tools; and knitr v`r info$otherPkgs$knitr$Version` [Xie, 2013] for reproducible research.
</font>

### Table of contents

Part I - [boring words](#outline)   
\* [Outline](#outline)  
\* [Motivation](#motive)  
\* [Problem](#prob)   
\* [Solution](#soln)  
\* [Issues](#issues)

Part II - [Example report](#example)  
\* [Abstract](#abstract)  
\* [Introduction](#introduction)  
\* [Methods](#methods)  
\* [Results](#results)  
\* [Discussion](#discussion)  
\* [References](#references)  

----

#### <a id = 'outline'>Outline</a>

* Reproduciblity
  * problem
  * solution
  * issues
* R projects
* knitr
  * code, logs, output
  * reports
  * slide shows using [slidy](http://www.w3.org/Talks/Tools/Slidy2/Overview.html)
* R packages
  * data storage - raw/final
  * functions - arguments/examples
  * documentation - variables/units
  * manuals/vignettes
* Useful tools
  * [pandoc](http://johnmacfarlane.net/pandoc/demos.html) - universal document converter
  * [git](http://git-scm.com)/[svn](http://www.sliksvn.com/en/download) for version control ([using rstudio](https://www.rstudio.com/ide/docs/version_control/overview))

### <a id = 'motive'>Reproducible research</a> 


#### <a id = 'prob'>problem</a>

Impossible to reproduce, difficult and time-consuming to update, easy to introduce errors and mistakes, not conducive to collaborations.

The spit out/chop up/string-together method for data management, analysis, and reporting are inefficient, laborious, and confusing not only to others reviewing one's work but also to future versions of oneself. I am guilty of "E: all of the above," but I have improved because no future version of myself has strangled me yet.

Inherited projects comprise even more headache: raw data is edited in spreadsheets; code is often split into many files across directories; there is very little documentation; reports are stitched together via the copy-and-paste method; dynamic reporting is impossible.

#### <a id = 'soln'>solution</a>

There are several tools to take advantage of:
  * RStudio projects: dedicated R sessions for different analyses
  * R packages: document data, man pages, functions and keep source code tidy and reusable
  * knitr:
    * keep all code, logs, output, graphics in a single document (html, pdf, [markdown](http://markdowntutorial.com))
    ![Rmd help](./figure/Rmd_help.png)    
    * generate publication-read reports complete with text, graphics, tables, [$\LaTeX$](http://wiki.geogebra.org/en/LaTeX-code_for_the_most_common_formulas) [equations](http://www.rstudio.com/ide/docs/authoring/using_markdown_equations)
    
Ethical advantages: transparency, reproducibility   
User advantages: documentation and dynamic reports; all-in-one documents    
Collaboration: projects in whole or part are often passed to others  

#### <a id = 'issues'>issues</a>

Obviously, this is just another thing to learn and put to use. The learning curve may be higher for those who are not familiar with markdown, $\LaTeX$, or html or if one is not comfortable doing most things in R (data cleaning and manipulation, generating nice tables and graphics). 

---

### <a id = 'example'>Example report</a>

* Disclaimer: this report is *highly* plagiarized but is intended only as an example.

```{r data}
## the packages I use for this example data cleaning/manipulation

library(rawr) 
library(Gmisc)
### data to use from the survival package
library(survival)
dat <- survival::lung
dat <- within(dat, {
  age_cat <- factor(as.numeric(cut(age, c(-Inf, 50, 60, 70, Inf))))
  meal_cat <- factor(as.numeric(cut(meal.cal,
    c(-Inf, quantile(meal.cal, c(.25, .5, .75), na.rm = TRUE), Inf))))
  wt_cat <- factor(as.numeric(cut(wt.loss, c(-Inf, quantile(wt.loss, c(.25, .5, .75), na.rm = TRUE), Inf))))
})
```

#### <a id = 'abstract'>Abstract</a>
*PURPOSE:* This study was developed to determine whether descriptive information from a patient-completed questionnaire could provide prognostic information that was independent from that already obtained by the patient's physician.
*PATIENTS & METHODS:* `r num2char(nrow(dat))` patients with advanced lung cancer were used from `r length(unique(dat$inst))` institutions from the North Central Cancer Treatment Group.
*RESULTS:* 
*CONCLUSION:* Data generated by a patient-completed questionnaire can provide important prognostic information independent from that obtained by other physician-determined prognostic factors.

#### <a id = 'introduction'>Introduction</a>
Lung cancer (also known as carcinoma of the lung) is a malignant lung tumor characterized by uncontrolled cell growth in tissues of the lung. If left untreated, this growth can spread beyond the lung by process of metastasis into nearby tissue or other parts of the body. Most cancers that start in the lung, known as primary lung cancers, are carcinomas that derive from epithelial cells. The main primary types are small-cell lung cancer (SCLC), also called oat cell cancer, and non-small-cell lung cancer (NSCLC).

#### <a id = 'methods'>Methods</a>
`r num2char(nrow(dat))` patients with advanced lung disease were taken from `r length(unique(dat$inst))` institutions. Continuous variables were summarized by means &pm; standard deviations and/or means and 95% confidence intervals. Categorical variables were summarized using proportions and 95% confidence intervals. Fisher's exact test was used to test for association. Survival summaries were performed using the method of Kaplan and Meier and Greenwood's variance formula. All statistical tests were two-sided and reported with exact p-values at a level of 5% significance.

Statistical analyses were performed using `r as.character(R.Version()$version.string)`.

#### <a id = 'results'>Results</a>
All `r nrow(dat)` patients were included in the analyses. Median age of patients was `r intr(dat$age, conf = NULL, digits = 0)`. `r num2char(sum(dat$sex == 1))` patients (`r round(sum(dat$sex == 1) * 100 / nrow(dat))`%) were male. Table 1 presents other patient characteristics. 

```{r table 1, echo=FALSE, results='asis', warning=FALSE}
## data for table 1, leaving analysis data unformatted
dat.t1 <- within(dat, {  
#   inst <- factor(inst, l
  status <- factor(status, levels = 1:2, labels = c('Censored','Dead'))
  sex <- factor(sex, levels = 1:2, labels = c('Male','Female'))
  age_cat <- factor(age_cat, levels = 1:4, 
                    labels = c('&le; 50','50 - 60','60 - 70','> 70'))
  ph.ecog <- factor(ph.ecog)
  ph.karno <- factor(ph.karno)
  pat.karno <- factor(pat.karno)
})
describeMedian_minmax <- function(...) describeMedian(..., iqr = FALSE)

getT1Stat <- function(varname, digits = 0){
  getDescriptionStatsBy(dat.t1[, varname], 
                        dat.t1$status, 
                        add_total_col=TRUE,
                        show_all_values=TRUE, 
                        hrzl_prop=FALSE,
                        statistics=FALSE, 
                        html=TRUE, 
                        digits=digits,
                        continuous_fn=describeMedian_minmax)
}

## save everything in a list
table_data <- list()
 
# get basic stats
table_data[["Age"]] <- rbind(getT1Stat("age"),
                             getT1Stat("age_cat"))
table_data[["Sex"]] <- getT1Stat("sex")
# table_data[["Institution"]] <- getT1Stat("inst")
table_data[["ECOG PS"]] <- getT1Stat("ph.ecog")
table_data[["Karnofsky PS<sup>&Dagger;</sup>"]] <- getT1Stat("ph.karno")
table_data[["Calories consumed<br>&nbsp;&nbspat meals"]] <- getT1Stat("meal.cal")
table_data[["Weight loss in<br>&nbsp;&nbsp;last six months"]] <- getT1Stat("wt.loss")

# Now merge everything into a matrix
# and create the rgroup & n.rgroup variables
output_data <- do.call(rbind, table_data)
rgroup <- names(table_data)
n.rgroup <- unname(sapply(rgroup, function(x) nrow(table_data[[x]])))
 
# Add a column spanner for the status columns
cgroup <- c("", "Patient status<sup>&dagger;</sup>")
n.cgroup <- c(1, 2) # '' spans 1 col; 'patient status' spans two
colnames(output_data) <- c(paste0('Total<br><font weight=normal; size=1>n = ',
                                  nrow(dat), '</font>'),
                           paste0('Censored<br><font weight=normal; size=1>n = ',
                                  sum(dat$status == 1),'</font>'),
                           paste0('Dead<br><font weight=normal; size=1>n = ',
                                  sum(dat$status == 2),'</font>'))
 
htmlTable(output_data, align = 'rccc', 
          rgroup = rgroup, n.rgroup = n.rgroup,
          altcol = c('grey97', 'white'), # -thanks to me!
          rgroupCSSseparator = '', 
          cgroup = cgroup,
          n.cgroup = n.cgroup,
          rowlabel = '',
          ctable = TRUE,
          caption = 'Table 1: Patient characteristics', 
          tfoot = paste0("<font size=1>Abbreviations: ECOG, Eastern Cooperative Oncology Group; PS, performance score</font><br>",
                       "<font size=1><sup>&dagger;</sup> Reasons for censoring include lost to follow-up, discontinuation from study, unknown.</font><br>",
                       "<font size = 1><sup>&Dagger;</sup> As rated by patients' physicians</font>"))
```

Figure I presents the overall survival of patients on study. 

```{r survival plots, fig.cap='Kaplan-Meier survival curve stratified by age groups.', fig.height=7, fig.width=11, warning=FALSE, message=FALSE, dev='CairoPNG'}
## km model
kmfit0 <- survfit(Surv(time = time, event = status) ~ strata(age_cat),
                   data = dat, conf.type = 'log-log')
## kmplot in rawr package:
kmplot(kmfit0, dev = FALSE, col.band = NULL, col.surv = 1:4, mark = '*',
       mar = c(4 + 4, 4 + 6, 2, 2) + .1,
       strata.lab=c('≤ 50','50-60','60-70','70+'))
```

A time-to-event analysis was performed using the method of Kaplan and Meier, a non-parametric maximum likelihood estimate of the survival function, $S(t)$. Table 2 presents the survival summary.

```{r survival summary, results='asis'}
tmp <- survival:::survmean(kmfit0, rmean = 'none')$matrix
tmp[ , 5] <- paste0(tmp[ , 5], ' (', tmp[ , 6],', ', tmp[ , 7],')')
tmp <- tmp[ , c(1, 4, 5)]
colnames(tmp) <- c('N','Events','Median<br>survival (95% CI)')
rownames(tmp) <- c('&le; 50','50 - 60','60 - 70','70+')
htmlTable(tmp, ctable = TRUE, align = 'cccc',
          n.rgroup = 1,
          caption = 'Table 2: Kaplan-Meier survival model results.', 
          title = 'Age<br> groups')
```

#### <a id = 'discussion'>Discussion</a>
Data generated by a patient-completed questionnaire can provide important prognostic information independent from that obtained by other physician-determined prognostic factors.

#### <a id = 'references'>References</a>

```{r, results='asis', echo=FALSE}
print(citation(package = 'Gmisc'), style = 'html')
```

Loprinzi CL. Laurie JA. Wieand HS. Krook JE. Novotny PJ. Kugler JW. Bartel J. Law M. Bateman M. Klatt NE. et al. "Prospective evaluation of prognostic variables from patient-completed questionnaires." North Central Cancer Treatment Group. *Journal of Clinical Oncology*. 12(3):601-7, 1994.

```{r, results='asis', echo=FALSE}
## r citation
print(citation(), style = 'html')
print(citation(package = 'survival'), style = 'html')
```

```{r, echo = TRUE}
sessionInfo()
```